<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="block-all-mixed-content">
    <!-- Prevent HTTPS upgrades -->
    <meta http-equiv="Strict-Transport-Security" content="max-age=0">
    <!-- Data URI favicon to prevent network request (avoids HSTS upgrade) -->
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" type="image/png">
    <link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" type="image/png">
    <title>Admin Dashboard - Richie's Lab</title>
    <script>
        // CRITICAL: Set favicon with HTTP BEFORE browser makes automatic request
        (function() {
            const currentHost = window.location.host;
            const httpFavicon = `http://${currentHost}/favicon.ico`;
            
            // Remove any existing favicon links
            const existingLinks = document.querySelectorAll('link[rel*="icon"]');
            existingLinks.forEach(link => link.remove());
            
            // Use data URI favicon to prevent any network request (avoids HSTS upgrade)
            // 1x1 transparent PNG data URI
            const dataUriFavicon = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
            
            const faviconLink = document.createElement('link');
            faviconLink.rel = 'icon';
            faviconLink.type = 'image/png';
            faviconLink.href = dataUriFavicon;
            document.head.appendChild(faviconLink);
            
            const shortcutLink = document.createElement('link');
            shortcutLink.rel = 'shortcut icon';
            shortcutLink.type = 'image/png';
            shortcutLink.href = dataUriFavicon;
            document.head.appendChild(shortcutLink);
            
            // Prevent browser from upgrading any resource requests
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                let url = args[0];
                if (typeof url === 'string' && url.includes('https://')) {
                    url = url.replace(/https:\/\//g, 'http://');
                    args[0] = url;
                }
                return originalFetch.apply(this, args);
            };
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .sidebar-header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: block;
            padding: 12px 15px;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: background 0.3s;
            cursor: pointer;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }

        .logout-btn {
            margin-top: 30px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Main Content */
        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 30px;
        }

        .content-section {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .section-header h2 {
            color: #333;
            font-size: 1.8em;
        }

        /* Login Form */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error.show {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
        }

        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .color-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        /* Announcement Cards */
        .announcement-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .announcement-card.active {
            border-left-color: #27ae60;
        }

        .announcement-card.inactive {
            border-left-color: #95a5a6;
            opacity: 0.7;
        }

        .announcement-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .announcement-title {
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
        }

        .announcement-actions {
            display: flex;
            gap: 10px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .badge-active {
            background: #27ae60;
            color: white;
        }

        .badge-inactive {
            background: #95a5a6;
            color: white;
        }

        .badge-priority {
            background: #f39c12;
            color: white;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h3 {
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .close-btn:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h1>üîê Admin Login</h1>
            <div class="error" id="errorMsg"></div>
            <form id="loginFormElement">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary" id="loginBtn" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminContainer" class="admin-container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>üîê Admin Panel</h1>
                <p>Richie's Lab</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-section="dashboard">üìä Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="announcements">üì¢ Announcements</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="ips">üìç IP Tracking</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="logins">üîê Login Attempts</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="users">üë• Users</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="bots">ü§ñ Bots</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="ip-whitelist">üõ°Ô∏è IP Whitelist</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="kofi">‚òï Ko-fi Subscriptions</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="settings">‚öôÔ∏è Settings</a>
                </li>
            </ul>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <div class="section-header">
                    <h2>üìä Dashboard</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Visitors</h3>
                        <div class="value" id="totalVisitors">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Unique IPs</h3>
                        <div class="value" id="uniqueIPs">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Login Attempts</h3>
                        <div class="value" id="loginAttempts">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Failed Logins</h3>
                        <div class="value" id="failedLogins">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Announcements</h3>
                        <div class="value" id="activeAnnouncements">-</div>
                    </div>
                </div>
            </div>

            <!-- Announcements Section -->
            <div id="announcements" class="content-section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0;">üì¢ Announcements</h2>
                    <button class="btn btn-primary" id="newAnnouncementBtn">+ New Announcement</button>
                </div>
                
                <!-- Announcement Form -->
                <div id="announcementFormSection" style="display: none; margin-top: 30px; padding: 25px; background: #f8f9fa; border-radius: 12px; border: 2px solid #e0e0e0;">
                    <h3 id="announcementFormHeading" style="margin-bottom: 20px; color: #333; font-size: 1.3em;">Create New Announcement</h3>
                    <form id="announcementForm">
                        <input type="hidden" id="announcementId" value="">
                        <div class="form-group">
                            <label for="announcementTitle">Title *</label>
                            <input type="text" id="announcementTitle" required placeholder="Enter announcement title" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        </div>
                        <div class="form-group">
                            <label for="announcementMessage">Message *</label>
                            <textarea id="announcementMessage" required placeholder="Enter announcement message" style="width: 100%; min-height: 120px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical;"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="announcementType">Type</label>
                                <select id="announcementType" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                    <option value="info">Info</option>
                                    <option value="warning">Warning</option>
                                    <option value="success">Success</option>
                                    <option value="error">Error</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="announcementPriority">Priority (1-10)</label>
                                <input type="number" id="announcementPriority" min="1" max="10" value="5" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Colors</label>
                            <div class="color-input-group">
                                <div>
                                    <label style="font-size: 0.9em; display: block; margin-bottom: 5px;">Background</label>
                                    <input type="color" id="announcementBgColor" value="#3498db" style="width: 100%; height: 40px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                </div>
                                <div>
                                    <label style="font-size: 0.9em; display: block; margin-bottom: 5px;">Text</label>
                                    <input type="color" id="announcementTextColor" value="#ffffff" style="width: 100%; height: 40px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                </div>
                                <div>
                                    <label style="font-size: 0.9em; display: block; margin-bottom: 5px;">Border</label>
                                    <input type="color" id="announcementBorderColor" value="#2980b9" style="width: 100%; height: 40px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="announcementStartDate">Start Date</label>
                                <input type="datetime-local" id="announcementStartDate" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div class="form-group">
                                <label for="announcementEndDate">End Date</label>
                                <input type="datetime-local" id="announcementEndDate" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="announcementIsActive" checked style="width: 18px; height: 18px; cursor: pointer;"> Active
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="announcementDismissible" checked style="width: 18px; height: 18px; cursor: pointer;"> Dismissible
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="announcementTargetPages">Target Pages (comma-separated, empty = all pages)</label>
                            <input type="text" id="announcementTargetPages" placeholder="/welcome, /admin" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 25px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">Save Announcement</button>
                            <button type="button" class="btn" id="cancelAnnouncementBtn" style="flex: 1; background: #95a5a6; color: white;">Cancel</button>
                        </div>
                    </form>
                </div>
                
                <div id="announcementsList" style="margin-top: 30px;">Loading announcements...</div>
            </div>

            <!-- IP Tracking Section -->
            <div id="ips" class="content-section">
                <div class="section-header">
                    <h2>üìç IP Tracking</h2>
                </div>
                <div class="table-container">
                    <div class="loading" id="ipsLoading">Loading IP addresses...</div>
                    <table class="table" id="ipsTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>IP Address</th>
                                <th>Last Seen</th>
                                <th>Visits</th>
                                <th>Last Path</th>
                            </tr>
                        </thead>
                        <tbody id="ipsBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Login Attempts Section -->
            <div id="logins" class="content-section">
                <div class="section-header">
                    <h2>üîê Login Attempts</h2>
                </div>
                <div class="table-container">
                    <div class="loading" id="loginsLoading">Loading login attempts...</div>
                    <table class="table" id="loginsTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>IP Address</th>
                                <th>Status</th>
                                <th>Time</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody id="loginsBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Bots Section -->
            <div id="bots" class="content-section">
                <div class="section-header">
                    <h2>ü§ñ Bot Management</h2>
                </div>
                
                <div class="table-container">
                    <div class="loading" id="botsLoading">Loading bots...</div>
                    <table class="table" id="botsTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Bot Name</th>
                                <th>Status</th>
                                <th>Games</th>
                                <th>Load</th>
                                <th>Last Heartbeat</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="botsBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users" class="content-section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>üë• User Management</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="exportUserData()" style="padding: 10px 20px; font-size: 14px;">üì• Export SQL</button>
                        <button class="btn btn-primary" onclick="document.getElementById('importFileInput').click()" style="padding: 10px 20px; font-size: 14px;">üì§ Import SQL</button>
                        <input type="file" id="importFileInput" accept=".sql" style="display: none;" onchange="importUserData(event)">
                    </div>
                </div>
                
                <!-- User Management Controls -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <!-- Search -->
                    <div style="flex: 1; min-width: 250px;">
                        <input type="text" id="userSearchInput" placeholder="Search users by name, email, role, status, or tier..." 
                               style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    </div>
                    
                    <!-- Users Per Page -->
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label for="usersPerPage" style="font-weight: 600; color: #333;">Show:</label>
                        <select id="usersPerPage" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; cursor: pointer;">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="0">All</option>
                        </select>
                    </div>
                </div>
                
                <!-- User Count Info -->
                <div id="userCountInfo" style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    Loading...
                </div>
                
                <div class="table-container">
                    <div class="loading" id="usersLoading">Loading users...</div>
                    <table class="table" id="usersTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Tier</th>
                                <th>Login Count</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersBody"></tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls -->
                <div id="userPagination" style="display: none; margin-top: 20px; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <button id="userPaginationPrev" class="btn" style="background: #95a5a6; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;" disabled>Previous</button>
                    <div id="userPaginationPages" style="display: flex; gap: 5px; align-items: center;"></div>
                    <button id="userPaginationNext" class="btn" style="background: #95a5a6; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;">Next</button>
                </div>
            </div>

            <!-- IP Whitelist Section -->
            <div id="ip-whitelist" class="content-section">
                <div class="section-header">
                    <h2>üõ°Ô∏è IP Whitelist Management</h2>
                    <p style="color: #666; margin-top: 10px;">Whitelisted IPs are exempt from account restrictions (one account per IP, multi-account detection)</p>
                </div>
                
                <!-- Add IP Form -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0; color: #333; margin-bottom: 15px;">Add IP to Whitelist</h3>
                    <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label for="newIPAddress" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">IP Address</label>
                            <input type="text" id="newIPAddress" placeholder="e.g., 192.168.1.1" 
                                   style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <button id="addIPBtn" class="btn btn-primary" style="padding: 12px 24px; white-space: nowrap;">
                            ‚ûï Add IP
                        </button>
                    </div>
                </div>
                
                <!-- Whitelisted IPs Table -->
                <div class="table-container">
                    <div class="loading" id="whitelistLoading">Loading whitelisted IPs...</div>
                    <table class="table" id="whitelistTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>IP Address</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="whitelistBody"></tbody>
                    </table>
                    <div id="whitelistEmpty" style="display: none; text-align: center; padding: 40px; color: #666;">
                        No IPs whitelisted yet. Add an IP above to get started.
                    </div>
                </div>
            </div>

            <!-- User Management Modal -->
            <div id="userManagementModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto; padding: 20px;">
                <div style="max-width: 1200px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); position: relative;">
                    <!-- Modal Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 25px; border-bottom: 2px solid #e0e0e0;">
                        <h2 style="margin: 0; color: #333; font-size: 1.5em;">üë§ User Management</h2>
                        <button data-action="close" class="user-mgmt-btn user-mgmt-close" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600;">‚úï Close</button>
                    </div>
                    
                    <!-- Modal Content -->
                    <div id="userManagementContent" style="padding: 25px; min-height: 200px;">
                        <div class="loading" style="padding: 2rem; text-align: center; color: #666;">Loading user data...</div>
                    </div>
                </div>
            </div>

            <!-- Tier Edit Modal -->
            <div id="tierEditModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center;">
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <h2 style="margin-bottom: 20px;">Edit User Tier</h2>
                    <div class="form-group">
                        <label for="editTier">Tier</label>
                        <select id="editTier" class="form-group input" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                            <option value="regular">Regular</option>
                            <option value="basic">Basic</option>
                            <option value="standard">Standard</option>
                            <option value="premium">Premium</option>
                        </select>
                    </div>
                    <div id="durationFields" style="display: none;">
                        <div class="form-group">
                            <label for="editDuration">Duration</label>
                            <input type="number" id="editDuration" min="1" value="1" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                        </div>
                        <div class="form-group">
                            <label for="editDurationUnit">Duration Unit</label>
                            <select id="editDurationUnit" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                                <option value="hours">Hours</option>
                                <option value="days">Days</option>
                                <option value="months">Months</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button onclick="saveTierEdit()" class="btn btn-primary" style="flex: 1;">Save</button>
                        <button onclick="closeTierEditModal()" class="btn" style="flex: 1; background: #95a5a6; color: white;">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <!-- Ko-fi Subscriptions Section -->
            <div id="kofi" class="content-section">
                <div class="section-header">
                    <h2>‚òï Ko-fi Subscriptions</h2>
                    <button onclick="loadKofiData()" class="btn btn-primary" style="margin-left: auto;">üîÑ Refresh</button>
                </div>
                
                <!-- Tier Statistics -->
                <div class="card" style="margin-bottom: 20px;">
                    <h3>Tier Statistics</h3>
                    <div id="kofiStats" style="padding: 20px;">
                        <p style="text-align: center; color: #666;">Loading tier statistics...</p>
                    </div>
                </div>

                <!-- Tier Members by Tier -->
                <div class="card" style="margin-bottom: 20px;">
                    <h3>Tier Memberships</h3>
                    <div id="kofiTiers" style="padding: 20px;">
                        <p style="text-align: center; color: #666;">Loading tier memberships...</p>
                    </div>
                </div>

                <!-- Recent Subscriptions -->
                <div class="card">
                    <h3>Recent Subscriptions & Payments</h3>
                    <div id="kofiSubscriptions" style="padding: 20px;">
                        <p style="text-align: center; color: #666;">Loading subscriptions...</p>
                    </div>
                </div>
            </div>

            <div id="settings" class="content-section">
                <div class="section-header">
                    <h2>‚öôÔ∏è Settings</h2>
                </div>
                <p>Settings panel coming soon...</p>
            </div>
        </div>
    </div>


    <script>
        // Admin server runs on different port (default: 3001)
        // Force HTTP protocol - use current host/port but always HTTP
        const currentHost = window.location.host;
        const API_BASE = `http://${currentHost}/api`;
        
        console.log('[ADMIN] API_BASE set to:', API_BASE);
        console.log('[ADMIN] Current location:', window.location.href);
        console.log('[ADMIN] Current protocol:', window.location.protocol);
        console.log('[ADMIN] Embedded data available:', !!window.__ADMIN_EMBEDDED_DATA__);
            if (window.__ADMIN_EMBEDDED_DATA__) {
                // Calculate total bot count from capacities
                let totalBotCount = 0;
                if (Array.isArray(window.__ADMIN_EMBEDDED_DATA__.bots)) {
                    totalBotCount = window.__ADMIN_EMBEDDED_DATA__.bots.reduce((sum, bot) => {
                        const capacity = parseInt(bot.capacity || 0, 10);
                        return sum + capacity;
                    }, 0);
                }
                
                console.log('[ADMIN] Embedded data structure:', {
                    hasStats: !!window.__ADMIN_EMBEDDED_DATA__.stats,
                    announcements: Array.isArray(window.__ADMIN_EMBEDDED_DATA__.announcements) ? window.__ADMIN_EMBEDDED_DATA__.announcements.length : 'not array',
                    bots: Array.isArray(window.__ADMIN_EMBEDDED_DATA__.bots) ? window.__ADMIN_EMBEDDED_DATA__.bots.length : 'not array',
                    totalBotCount: totalBotCount, // Sum of all capacities
                    users: Array.isArray(window.__ADMIN_EMBEDDED_DATA__.users) ? window.__ADMIN_EMBEDDED_DATA__.users.length : 'not array',
                    ips: Array.isArray(window.__ADMIN_EMBEDDED_DATA__.ips) ? window.__ADMIN_EMBEDDED_DATA__.ips.length : 'not array',
                    loginAttempts: Array.isArray(window.__ADMIN_EMBEDDED_DATA__.loginAttempts) ? window.__ADMIN_EMBEDDED_DATA__.loginAttempts.length : 'not array',
                });
            }
        
        // COMPLETELY REPLACE fetch with XMLHttpRequest to bypass browser HSTS
        // Browser HSTS cache will upgrade fetch() requests, but XMLHttpRequest might work
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            let url = args[0];
            let options = args[1] || {};
            let urlString = '';
            
            // Handle Request object or string
            if (url instanceof Request) {
                urlString = url.url;
                // Extract options from Request
                options = {
                    method: url.method,
                    headers: url.headers,
                    body: url.body,
                    mode: url.mode,
                    credentials: url.credentials,
                    cache: url.cache,
                    redirect: url.redirect,
                };
            } else if (typeof url === 'string') {
                urlString = url;
            }
            
            // FORCE HTTP - replace ANY https:// with http://
            if (urlString) {
                urlString = urlString.replace(/https:\/\//g, 'http://');
                
                // If it's a relative URL, make it absolute with HTTP
                if (urlString.startsWith('/')) {
                    urlString = `http://${currentHost}${urlString}`;
                } else if (!urlString.startsWith('http://') && !urlString.startsWith('https://')) {
                    urlString = `http://${currentHost}${urlString.startsWith('/') ? '' : '/'}${urlString}`;
                }
                
                // Final check
                urlString = urlString.replace(/https:\/\//g, 'http://');
                console.log('[ADMIN] FORCED HTTP URL:', urlString);
            }
            
            // Use XMLHttpRequest instead of fetch to bypass HSTS
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open(options.method || 'GET', urlString, true);
                xhr.withCredentials = options.credentials === 'include' || options.credentials === true;
                
                // Set headers
                if (options.headers) {
                    if (options.headers instanceof Headers) {
                        options.headers.forEach((value, key) => {
                            xhr.setRequestHeader(key, value);
                        });
                    } else if (typeof options.headers === 'object') {
                        Object.keys(options.headers).forEach(key => {
                            xhr.setRequestHeader(key, options.headers[key]);
                        });
                    }
                }
                
                xhr.onload = function() {
                    const response = {
                        ok: xhr.status >= 200 && xhr.status < 300,
                        status: xhr.status,
                        statusText: xhr.statusText,
                        headers: {
                            get: function(name) {
                                return xhr.getResponseHeader(name);
                            }
                        },
                        json: async function() {
                            return JSON.parse(xhr.responseText);
                        },
                        text: async function() {
                            return xhr.responseText;
                        }
                    };
                    resolve(response);
                };
                
                xhr.onerror = function() {
                    reject(new Error('Network error'));
                };
                
                xhr.send(options.body || null);
            });
        };
        let authToken = localStorage.getItem('adminToken');
        let currentSection = 'dashboard';
        
        // User management state
        let allUsers = [];
        let filteredUsers = [];
        let currentUserPage = 1;
        let usersPerPage = 25;
        let userSearchQuery = '';

        // Announcement form management - completely rewritten
        function showAnnouncementForm(isEdit = false, announcementId = null) {
            const formSection = document.getElementById('announcementFormSection');
            const heading = document.getElementById('announcementFormHeading');
            const form = document.getElementById('announcementForm');
            
            if (!formSection || !heading || !form) {
                console.error('Announcement form elements not found');
                return;
            }
            
            formSection.style.display = 'block';
            heading.textContent = isEdit ? 'Edit Announcement' : 'Create New Announcement';
            document.getElementById('announcementId').value = announcementId || '';
            
            if (!isEdit) {
                // Reset form for new announcement
                form.reset();
                document.getElementById('announcementPriority').value = '5';
                document.getElementById('announcementBgColor').value = '#3498db';
                document.getElementById('announcementTextColor').value = '#ffffff';
                document.getElementById('announcementBorderColor').value = '#2980b9';
                document.getElementById('announcementIsActive').checked = true;
                document.getElementById('announcementDismissible').checked = true;
            } else if (announcementId) {
                loadAnnouncementForEdit(announcementId);
            }
            
            // Scroll to form
            formSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function hideAnnouncementForm() {
            const formSection = document.getElementById('announcementFormSection');
            if (formSection) {
                formSection.style.display = 'none';
                document.getElementById('announcementForm').reset();
                document.getElementById('announcementId').value = '';
            }
        }
        
        // Set up event listeners for announcement form
        function setupAnnouncementForm() {
            const newBtn = document.getElementById('newAnnouncementBtn');
            const cancelBtn = document.getElementById('cancelAnnouncementBtn');
            const form = document.getElementById('announcementForm');
            
            if (newBtn) {
                newBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showAnnouncementForm(false);
                });
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    hideAnnouncementForm();
                });
            }
            
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await saveAnnouncement();
                });
            }
        }
        
        async function saveAnnouncement() {
            const id = document.getElementById('announcementId').value;
            const formData = {
                title: document.getElementById('announcementTitle').value.trim(),
                message: document.getElementById('announcementMessage').value.trim(),
                type: document.getElementById('announcementType').value,
                priority: parseInt(document.getElementById('announcementPriority').value) || 5,
                backgroundColor: document.getElementById('announcementBgColor').value,
                textColor: document.getElementById('announcementTextColor').value,
                borderColor: document.getElementById('announcementBorderColor').value,
                isActive: document.getElementById('announcementIsActive').checked,
                dismissible: document.getElementById('announcementDismissible').checked,
                targetPages: document.getElementById('announcementTargetPages').value.split(',').map(p => p.trim()).filter(p => p),
            };
            
            const startDate = document.getElementById('announcementStartDate').value;
            const endDate = document.getElementById('announcementEndDate').value;
            if (startDate) {
                // Convert datetime-local to ISO string
                const startDateObj = new Date(startDate);
                formData.startDate = startDateObj.toISOString();
                console.log('[ANNOUNCEMENT] Start date:', startDate, '->', formData.startDate);
            }
            if (endDate) {
                // Convert datetime-local to ISO string
                const endDateObj = new Date(endDate);
                formData.endDate = endDateObj.toISOString();
                console.log('[ANNOUNCEMENT] End date:', endDate, '->', formData.endDate);
            }
            
            if (!formData.title || !formData.message) {
                alert('Please fill in title and message');
                return;
            }
            
            console.log('[ANNOUNCEMENT] Saving announcement:', formData);
            console.log('[ANNOUNCEMENT] Is active:', formData.isActive, typeof formData.isActive);
            
            try {
                const url = id ? `${API_BASE}/admin/announcements/${id}` : `${API_BASE}/admin/announcements`;
                const method = id ? 'PUT' : 'POST';
                console.log('[ANNOUNCEMENT] Request URL:', url);
                console.log('[ANNOUNCEMENT] Request method:', method);
                
                const response = await makeAuthRequest(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });
                
                console.log('[ANNOUNCEMENT] Response status:', response.status);
                console.log('[ANNOUNCEMENT] Response ok:', response.ok);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('[ANNOUNCEMENT] Success response:', data);
                    hideAnnouncementForm();
                    loadAnnouncements();
                    if (currentSection === 'dashboard') loadDashboardData();
                    alert('Announcement saved successfully!');
                } else {
                    const errorText = await response.text();
                    console.error('[ANNOUNCEMENT] Error response:', errorText);
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { error: errorText };
                    }
                    alert('Error saving announcement: ' + (errorData.error || errorData.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('[ANNOUNCEMENT] Error saving announcement:', error);
                console.error('[ANNOUNCEMENT] Error stack:', error.stack);
                alert('Error saving announcement: ' + error.message);
            }
        }

        // Set up announcement form when page loads
        setupAnnouncementForm();
        
        // Check if already logged in
        if (authToken) {
            checkAuth();
        } else {
            // Even if not logged in, log embedded data availability
            console.log('[ADMIN] No auth token, embedded data check:', !!window.__ADMIN_EMBEDDED_DATA__);
        }
        
        // Initialize dashboard on page load if embedded data is available
        if (window.__ADMIN_EMBEDDED_DATA__) {
            console.log('[ADMIN] Embedded data found on page load, initializing dashboard...');
            // Dashboard will be loaded when section is shown
        }

        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = e.target.getAttribute('data-section');
                showSection(section);
            });
        });

        function showSection(section) {
            console.log('[ADMIN] showSection called with:', section);
            console.log('[ADMIN] Embedded data available:', !!window.__ADMIN_EMBEDDED_DATA__);
            if (window.__ADMIN_EMBEDDED_DATA__) {
                console.log('[ADMIN] Embedded data:', {
                    hasStats: !!window.__ADMIN_EMBEDDED_DATA__.stats,
                    announcementsCount: window.__ADMIN_EMBEDDED_DATA__.announcements?.length || 0,
                    botsCount: window.__ADMIN_EMBEDDED_DATA__.bots?.length || 0,
                    usersCount: window.__ADMIN_EMBEDDED_DATA__.users?.length || 0,
                    ipsCount: window.__ADMIN_EMBEDDED_DATA__.ips?.length || 0,
                    loginAttemptsCount: window.__ADMIN_EMBEDDED_DATA__.loginAttempts?.length || 0,
                });
            }
            
            // Update nav
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const navLink = document.querySelector(`[data-section="${section}"]`);
            if (navLink) {
                navLink.classList.add('active');
            }

            // Update content
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            const sectionElement = document.getElementById(section);
            if (sectionElement) {
                sectionElement.classList.add('active');
            } else {
                console.error('[ADMIN] Section element not found:', section);
            }

            currentSection = section;

            // Load section data
            if (section === 'dashboard') {
                console.log('[ADMIN] Loading dashboard data...');
                loadDashboardData();
            } else if (section === 'announcements') {
                console.log('[ADMIN] Loading announcements...');
                loadAnnouncements();
                hideAnnouncementForm(); // Hide form when switching away
            } else if (section === 'ips') {
                console.log('[ADMIN] Loading IPs...');
                loadIPs();
            } else if (section === 'logins') {
                console.log('[ADMIN] Loading login attempts...');
                loadLoginAttempts();
            } else if (section === 'bots') {
                console.log('[ADMIN] Loading bots...');
                loadBots();
            } else if (section === 'users') {
                console.log('[ADMIN] Loading users...');
                loadUsers();
            } else if (section === 'kofi') {
                console.log('[ADMIN] Loading Ko-fi data...');
                if (typeof loadKofiData === 'function') {
                    loadKofiData();
                }
            }
        }

        // Login form handler
        document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const errorMsg = document.getElementById('errorMsg');
            const loginBtn = document.getElementById('loginBtn');

            errorMsg.classList.remove('show');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';

            try {
                // FORCE HTTP - ensure API_BASE is HTTP
                let loginUrl = `${API_BASE}/admin/login`;
                loginUrl = loginUrl.replace(/https:\/\//g, 'http://');
                if (!loginUrl.startsWith('http://')) {
                    loginUrl = `http://${currentHost}${loginUrl.startsWith('/') ? '' : '/'}${loginUrl}`;
                }
                console.log('[ADMIN LOGIN] Attempting login to (FORCED HTTP):', loginUrl);
                console.log('[ADMIN LOGIN] API_BASE was:', API_BASE);
                
                // Use XMLHttpRequest to bypass browser HTTPS upgrade
                const response = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', loginUrl, true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.withCredentials = true;
                    
                    xhr.onload = function() {
                        // Create a Response-like object
                        const response = {
                            ok: xhr.status >= 200 && xhr.status < 300,
                            status: xhr.status,
                            statusText: xhr.statusText,
                            headers: {
                                get: function(name) {
                                    return xhr.getResponseHeader(name);
                                }
                            },
                            json: async function() {
                                return JSON.parse(xhr.responseText);
                            },
                            text: async function() {
                                return xhr.responseText;
                            }
                        };
                        resolve(response);
                    };
                    
                    xhr.onerror = function() {
                        reject(new Error('Network error'));
                    };
                    
                    xhr.send(JSON.stringify({ username, password }));
                });

                console.log('[ADMIN LOGIN] Response status:', response.status);
                console.log('[ADMIN LOGIN] Response ok:', response.ok);

                let data;
                try {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        data = await response.json();
                    } else {
                        const text = await response.text();
                        console.error('[ADMIN LOGIN] Non-JSON response:', text);
                        throw new Error('Server returned non-JSON response');
                    }
                } catch (parseError) {
                    console.error('[ADMIN LOGIN] JSON parse error:', parseError);
                    throw new Error('Invalid server response');
                }

                if (response.ok && data.success) {
                    authToken = data.token;
                    localStorage.setItem('adminToken', authToken);
                    showAdminPanel();
                    loadDashboardData();
                } else {
                    errorMsg.textContent = data.error || 'Login failed';
                    errorMsg.classList.add('show');
                }
            } catch (error) {
                console.error('[ADMIN LOGIN] Error:', error);
                console.error('[ADMIN LOGIN] Error name:', error.name);
                console.error('[ADMIN LOGIN] Error message:', error.message);
                errorMsg.textContent = error.message || 'Network error. Please try again.';
                errorMsg.classList.add('show');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
            }
        });

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', () => {
            authToken = null;
            localStorage.removeItem('adminToken');
            showLogin();
        });

        async function checkAuth() {
            try {
                const response = await makeAuthRequest(`${API_BASE}/admin/dashboard`);
                if (response.ok) {
                    showAdminPanel();
                    loadDashboardData();
                } else {
                    // If auth fails, clear token and show login
                    authToken = null;
                    localStorage.removeItem('adminToken');
                    showLogin();
                }
            } catch (error) {
                console.error('Auth check error:', error);
                // On network error, still try to show login (might be first visit)
                authToken = null;
                localStorage.removeItem('adminToken');
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('adminContainer').style.display = 'none';
        }

        function showAdminPanel() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'flex';
        }

        async function loadDashboardData() {
            console.log('[ADMIN] loadDashboardData called');
            try {
                // Use embedded data if available
                if (window.__ADMIN_EMBEDDED_DATA__ && window.__ADMIN_EMBEDDED_DATA__.stats) {
                    console.log('[ADMIN] Using embedded stats');
                    const stats = window.__ADMIN_EMBEDDED_DATA__.stats;
                    document.getElementById('totalVisitors').textContent = stats.totalIPs || 0;
                    document.getElementById('uniqueIPs').textContent = stats.totalIPs || 0;
                    document.getElementById('loginAttempts').textContent = stats.loginAttempts || 0;
                    document.getElementById('failedLogins').textContent = stats.failedLogins || 0;
                    
                    if (window.__ADMIN_EMBEDDED_DATA__.announcements) {
                        const active = window.__ADMIN_EMBEDDED_DATA__.announcements.filter(a => a.isActive).length;
                        document.getElementById('activeAnnouncements').textContent = active;
                    } else if (stats.activeAnnouncements !== undefined) {
                        document.getElementById('activeAnnouncements').textContent = stats.activeAnnouncements;
                    }
                    return; // Data loaded from embedded source
                }
                
                console.log('[ADMIN] No embedded stats, fetching from API...');
                // Fallback to API if no embedded data
                const statsResponse = await makeAuthRequest(`${API_BASE}/admin/stats`);
                console.log('[ADMIN] Stats API response:', statsResponse.status, statsResponse.ok);
                if (statsResponse.ok) {
                    const data = await statsResponse.json();
                    console.log('[ADMIN] Stats data:', data);
                    if (data.success && data.stats) {
                        document.getElementById('totalVisitors').textContent = data.stats.totalIPs || 0;
                        document.getElementById('uniqueIPs').textContent = data.stats.totalIPs || 0;
                        document.getElementById('loginAttempts').textContent = data.stats.loginAttempts || 0;
                        document.getElementById('failedLogins').textContent = data.stats.failedLogins || 0;
                        
                        if (data.stats.activeAnnouncements !== undefined) {
                            document.getElementById('activeAnnouncements').textContent = data.stats.activeAnnouncements;
                        }
                    }
                }

                const activeAnnEl = document.getElementById('activeAnnouncements');
                if (activeAnnEl && activeAnnEl.textContent === '-') {
                    const announcementsResponse = await makeAuthRequest(`${API_BASE}/admin/announcements`);
                    if (announcementsResponse.ok) {
                        const annData = await announcementsResponse.json();
                        if (annData.success) {
                            const active = annData.announcements.filter(a => a.isActive).length;
                            document.getElementById('activeAnnouncements').textContent = active;
                        }
                    }
                }
            } catch (error) {
                console.error('[ADMIN] Error loading dashboard:', error);
            }
        }

        async function loadAnnouncements() {
            console.log('[ADMIN] loadAnnouncements called');
            try {
                // Use embedded data if available AND has content
                if (window.__ADMIN_EMBEDDED_DATA__ && 
                    Array.isArray(window.__ADMIN_EMBEDDED_DATA__.announcements) && 
                    window.__ADMIN_EMBEDDED_DATA__.announcements.length > 0) {
                    console.log('[ADMIN] Using embedded announcements:', window.__ADMIN_EMBEDDED_DATA__.announcements.length);
                    displayAnnouncements(window.__ADMIN_EMBEDDED_DATA__.announcements);
                    return; // Data loaded from embedded source
                }
                
                console.log('[ADMIN] No embedded announcements or empty, fetching from API...');
                // Fallback to API
                const response = await makeAuthRequest(`${API_BASE}/admin/announcements`);
                console.log('[ADMIN] Announcements API response:', response.status, response.ok);
                if (response.ok) {
                    const data = await response.json();
                    console.log('[ADMIN] Announcements data:', data);
                    if (data.success) {
                        displayAnnouncements(data.announcements || []);
                    } else {
                        console.error('[ADMIN] Announcements API error:', data.error);
                    }
                } else {
                    const errorText = await response.text().catch(() => 'Unknown error');
                    console.error('[ADMIN] Announcements API failed:', response.status, errorText);
                }
            } catch (error) {
                console.error('[ADMIN] Error loading announcements:', error);
                const container = document.getElementById('announcementsList');
                if (container) {
                    container.textContent = 'Error loading announcements: ' + error.message;
                }
            }
        }

        function displayAnnouncements(announcements) {
            const container = document.getElementById('announcementsList');
            if (announcements.length === 0) {
                container.innerHTML = '<p>No announcements yet. Create one to get started!</p>';
                return;
            }

            container.innerHTML = announcements.map(ann => `
                <div class="announcement-card ${ann.isActive ? 'active' : 'inactive'}">
                    <div class="announcement-header">
                        <div>
                            <div class="announcement-title">${ann.title}</div>
                            <div style="margin-top: 5px;">
                                <span class="badge ${ann.isActive ? 'badge-active' : 'badge-inactive'}">${ann.isActive ? 'Active' : 'Inactive'}</span>
                                <span class="badge badge-priority">Priority: ${ann.priority}</span>
                            </div>
                        </div>
                        <div class="announcement-actions">
                            <button class="btn btn-primary" data-action="edit" data-id="${ann.id}">Edit</button>
                            <button class="btn ${ann.isActive ? 'btn-danger' : 'btn-success'}" data-action="toggle" data-id="${ann.id}">${ann.isActive ? 'Deactivate' : 'Activate'}</button>
                            <button class="btn btn-danger" data-action="delete" data-id="${ann.id}">Delete</button>
                        </div>
                    </div>
                    <div style="color: #666; margin-top: 10px;">${ann.message}</div>
                    <div style="font-size: 0.9em; color: #999; margin-top: 10px;">
                        ${ann.startDate ? `Start: ${new Date(ann.startDate).toLocaleString()}` : ''}
                        ${ann.endDate ? ` | End: ${new Date(ann.endDate).toLocaleString()}` : ''}
                    </div>
                </div>
            `).join('');
            
            // Set up event listeners for action buttons
            container.querySelectorAll('[data-action]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    const id = parseInt(this.getAttribute('data-id'));
                    
                    if (action === 'edit') {
                        window.editAnnouncement(id);
                    } else if (action === 'toggle') {
                        window.toggleAnnouncement(id);
                    } else if (action === 'delete') {
                        window.deleteAnnouncement(id);
                    }
                });
            });
        }

        // Additional functions for announcement management (globally accessible)
        window.editAnnouncement = function(id) {
            showAnnouncementForm(true, id);
        };

        window.toggleAnnouncement = async function(id) {
            try {
                const response = await makeAuthRequest(`${API_BASE}/admin/announcements/${id}/toggle`, { method: 'PATCH' });
                if (response.ok) {
                    loadAnnouncements();
                    if (currentSection === 'dashboard') loadDashboardData();
                }
            } catch (error) {
                alert('Error toggling announcement');
            }
        }

        window.deleteAnnouncement = async function(id) {
            if (!confirm('Are you sure you want to delete this announcement?')) return;
            try {
                const response = await makeAuthRequest(`${API_BASE}/admin/announcements/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadAnnouncements();
                    if (currentSection === 'dashboard') loadDashboardData();
                }
            } catch (error) {
                alert('Error deleting announcement');
            }
        }



        async function loadAnnouncementForEdit(id) {
            try {
                const response = await makeAuthRequest(`${API_BASE}/admin/announcements/${id}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        const ann = data.announcement;
                        document.getElementById('announcementTitle').value = ann.title;
                        document.getElementById('announcementMessage').value = ann.message;
                        document.getElementById('announcementType').value = ann.type;
                        document.getElementById('announcementPriority').value = ann.priority;
                        document.getElementById('announcementBgColor').value = ann.backgroundColor;
                        document.getElementById('announcementTextColor').value = ann.textColor;
                        document.getElementById('announcementBorderColor').value = ann.borderColor;
                        document.getElementById('announcementIsActive').checked = ann.isActive;
                        document.getElementById('announcementDismissible').checked = ann.dismissible;
                        document.getElementById('announcementTargetPages').value = ann.targetPages.join(', ');
                        
                        if (ann.startDate) {
                            const start = new Date(ann.startDate);
                            document.getElementById('announcementStartDate').value = start.toISOString().slice(0, 16);
                        }
                        if (ann.endDate) {
                            const end = new Date(ann.endDate);
                            document.getElementById('announcementEndDate').value = end.toISOString().slice(0, 16);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading announcement:', error);
            }
        }


        async function loadIPs() {
            console.log('[ADMIN] loadIPs called');
            try {
                // Use embedded data if available AND has content
                if (window.__ADMIN_EMBEDDED_DATA__ && 
                    Array.isArray(window.__ADMIN_EMBEDDED_DATA__.ips) && 
                    window.__ADMIN_EMBEDDED_DATA__.ips.length > 0) {
                    console.log('[ADMIN] Using embedded IPs:', window.__ADMIN_EMBEDDED_DATA__.ips.length);
                    const tbody = document.getElementById('ipsBody');
                    tbody.innerHTML = '';
                    window.__ADMIN_EMBEDDED_DATA__.ips.forEach(ipData => {
                        const row = tbody.insertRow();
                        row.insertCell(0).textContent = ipData.ip;
                        row.insertCell(1).textContent = new Date(ipData.lastSeen).toLocaleString();
                        row.insertCell(2).textContent = ipData.count;
                        row.insertCell(3).textContent = ipData.lastPath || '-';
                    });
                    document.getElementById('ipsLoading').style.display = 'none';
                    document.getElementById('ipsTable').style.display = 'table';
                    return; // Data loaded from embedded source
                }
                
                console.log('[ADMIN] No embedded IPs or empty, fetching from API...');
                // Fallback to API
                const response = await makeAuthRequest(`${API_BASE}/admin/ips?limit=50`);
                console.log('[ADMIN] IPs API response:', response.status, response.ok);
                if (response.ok) {
                    const data = await response.json();
                    console.log('[ADMIN] IPs data:', data);
                    if (data.success && data.ips) {
                        const tbody = document.getElementById('ipsBody');
                        tbody.innerHTML = '';
                        data.ips.forEach(ipData => {
                            const row = tbody.insertRow();
                            row.insertCell(0).textContent = ipData.ip;
                            row.insertCell(1).textContent = new Date(ipData.lastSeen).toLocaleString();
                            row.insertCell(2).textContent = ipData.count;
                            row.insertCell(3).textContent = ipData.lastPath || '-';
                        });
                        document.getElementById('ipsLoading').style.display = 'none';
                        document.getElementById('ipsTable').style.display = 'table';
                    }
                } else {
                    const errorText = await response.text().catch(() => 'Unknown error');
                    console.error('[ADMIN] IPs API failed:', response.status, errorText);
                }
            } catch (error) {
                console.error('[ADMIN] Error loading IPs:', error);
                const loadingEl = document.getElementById('ipsLoading');
                if (loadingEl) {
                    loadingEl.textContent = 'Error loading IP addresses: ' + error.message;
                }
            }
        }

        async function loadLoginAttempts() {
            console.log('[ADMIN] loadLoginAttempts called');
            try {
                // Use embedded data if available AND has content
                if (window.__ADMIN_EMBEDDED_DATA__ && 
                    Array.isArray(window.__ADMIN_EMBEDDED_DATA__.loginAttempts) && 
                    window.__ADMIN_EMBEDDED_DATA__.loginAttempts.length > 0) {
                    console.log('[ADMIN] Using embedded login attempts:', window.__ADMIN_EMBEDDED_DATA__.loginAttempts.length);
                    const tbody = document.getElementById('loginsBody');
                    tbody.innerHTML = '';
                    window.__ADMIN_EMBEDDED_DATA__.loginAttempts.forEach(attempt => {
                        const row = tbody.insertRow();
                        row.insertCell(0).textContent = attempt.username || 'N/A';
                        row.insertCell(1).textContent = attempt.ip;
                        row.insertCell(2).innerHTML = attempt.success 
                            ? '<span style="color: green;">Success</span>' 
                            : '<span style="color: red;">Failed</span>';
                        row.insertCell(3).textContent = new Date(attempt.timestamp).toLocaleString();
                        row.insertCell(4).textContent = attempt.reason || '-';
                    });
                    document.getElementById('loginsLoading').style.display = 'none';
                    document.getElementById('loginsTable').style.display = 'table';
                    return; // Data loaded from embedded source
                }
                
                console.log('[ADMIN] No embedded login attempts or empty, fetching from API...');
                // Fallback to API
                const response = await makeAuthRequest(`${API_BASE}/admin/login-attempts?limit=50`);
                console.log('[ADMIN] Login attempts API response:', response.status, response.ok);
                if (response.ok) {
                    const data = await response.json();
                    console.log('[ADMIN] Login attempts data:', data);
                    if (data.success && data.attempts) {
                        const tbody = document.getElementById('loginsBody');
                        tbody.innerHTML = '';
                        data.attempts.forEach(attempt => {
                            const row = tbody.insertRow();
                            row.insertCell(0).textContent = attempt.username || 'N/A';
                            row.insertCell(1).textContent = attempt.ip;
                            row.insertCell(2).innerHTML = attempt.success 
                                ? '<span style="color: green;">Success</span>' 
                                : '<span style="color: red;">Failed</span>';
                            row.insertCell(3).textContent = new Date(attempt.timestamp).toLocaleString();
                            row.insertCell(4).textContent = attempt.reason || '-';
                        });
                        document.getElementById('loginsLoading').style.display = 'none';
                        document.getElementById('loginsTable').style.display = 'table';
                    }
                } else {
                    const errorText = await response.text().catch(() => 'Unknown error');
                    console.error('[ADMIN] Login attempts API failed:', response.status, errorText);
                }
            } catch (error) {
                console.error('[ADMIN] Error loading login attempts:', error);
                const loadingEl = document.getElementById('loginsLoading');
                if (loadingEl) {
                    loadingEl.textContent = 'Error loading login attempts: ' + error.message;
                }
            }
        }

        // Use XMLHttpRequest to bypass browser HTTPS upgrade
        function makeAuthRequest(url, options = {}) {
            // Force HTTP
            let requestUrl = url;
            requestUrl = requestUrl.replace(/https:\/\//g, 'http://');
            if (!requestUrl.startsWith('http://') && !requestUrl.startsWith('https://')) {
                requestUrl = `http://${currentHost}${requestUrl.startsWith('/') ? '' : '/'}${requestUrl}`;
            }
            
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open(options.method || 'GET', requestUrl, true);
                xhr.withCredentials = true;
                
                // Set headers
                if (options.headers) {
                    Object.keys(options.headers).forEach(key => {
                        xhr.setRequestHeader(key, options.headers[key]);
                    });
                }
                xhr.setRequestHeader('Authorization', `Bearer ${authToken}`);
                
                // Set response type for blob requests
                if (options.responseType === 'blob') {
                    xhr.responseType = 'blob';
                }
                
                xhr.onload = function() {
                    const response = {
                        ok: xhr.status >= 200 && xhr.status < 300,
                        status: xhr.status,
                        statusText: xhr.statusText,
                        headers: {
                            get: function(name) {
                                return xhr.getResponseHeader(name);
                            }
                        },
                        json: async function() {
                            return JSON.parse(xhr.responseText);
                        },
                        text: async function() {
                            return xhr.responseText;
                        },
                        blob: async function() {
                            if (xhr.responseType === 'blob') {
                                return xhr.response;
                            }
                            return new Blob([xhr.response], { type: xhr.getResponseHeader('Content-Type') || 'application/octet-stream' });
                        }
                    };
                    resolve(response);
                };
                
                xhr.onerror = function() {
                    reject(new Error('Network error'));
                };
                
                xhr.send(options.body || null);
            });
        }

        // Bot Management Functions
        async function loadBots() {
            console.log('[ADMIN] loadBots called');
            const loading = document.getElementById('botsLoading');
            const table = document.getElementById('botsTable');
            const body = document.getElementById('botsBody');
            
            if (!loading || !table || !body) {
                console.error('[ADMIN] Bot elements not found:', { loading: !!loading, table: !!table, body: !!body });
                return;
            }
            
            loading.style.display = 'block';
            table.style.display = 'none';
            
            try {
                // Use embedded data if available AND has content
                if (window.__ADMIN_EMBEDDED_DATA__ && 
                    Array.isArray(window.__ADMIN_EMBEDDED_DATA__.bots) && 
                    window.__ADMIN_EMBEDDED_DATA__.bots.length > 0) {
                    console.log('[ADMIN] Using embedded bots:', window.__ADMIN_EMBEDDED_DATA__.bots.length);
                    displayBots(window.__ADMIN_EMBEDDED_DATA__.bots);
                    loading.style.display = 'none';
                    table.style.display = 'table';
                    return; // Data loaded from embedded source
                }
                
                console.log('[ADMIN] No embedded bots or empty, fetching from API...');
                // Fallback to API
                const response = await makeAuthRequest(`${API_BASE}/admin/bots`);
                console.log('[ADMIN] Bots API response:', response.status, response.ok);
                if (response.ok) {
                    const data = await response.json();
                    console.log('[ADMIN] Bots data:', data);
                    if (data.success && data.bots) {
                        displayBots(data.bots);
                        loading.style.display = 'none';
                        table.style.display = 'table';
                    } else {
                        throw new Error(data.error || 'Failed to load bots');
                    }
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Failed to load bots' }));
                    throw new Error(errorData.error || 'Failed to load bots');
                }
            } catch (error) {
                console.error('[ADMIN] Error loading bots:', error);
                loading.textContent = `Error: ${error.message}`;
            }
        }
        
        function displayBots(bots) {
            const body = document.getElementById('botsBody');
            if (!body) return;
            
            if (bots.length === 0) {
                body.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #666;">No bots registered yet.</td></tr>';
                return;
            }
            
            const gameNames = {
                'plza': 'PLZA',
                'bdsp': 'BDSP',
                'SV': 'SV',
                'SWSH': 'SWSH',
                'LA': 'LA',
                'lgpe': 'LGPE'
            };
            
            body.innerHTML = bots.map(bot => {
                const statusColors = {
                    'online': { bg: '#10b981', text: 'white' },
                    'idle': { bg: '#3b82f6', text: 'white' },
                    'active': { bg: '#8c52ff', text: 'white' },
                    'offline': { bg: '#6b7280', text: 'white' },
                    'error': { bg: '#ef4444', text: 'white' }
                };
                
                const statusInfo = statusColors[bot.status] || { bg: '#6b7280', text: 'white' };
                const games = bot.supported_games && bot.supported_games.length > 0 
                    ? bot.supported_games.map(g => gameNames[g] || g).join(', ')
                    : 'All';
                const loadPercent = bot.capacity > 0 ? Math.round((bot.current_load / bot.capacity) * 100) : 0;
                const lastHeartbeat = bot.last_heartbeat 
                    ? new Date(bot.last_heartbeat).toLocaleString()
                    : 'Never';
                const created = bot.created_at 
                    ? new Date(bot.created_at).toLocaleDateString()
                    : 'Unknown';
                
                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="text" id="botName_${bot.bot_id}" value="${escapeHtml(bot.bot_name || 'Unnamed Bot')}" 
                                       style="flex: 1; padding: 6px 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                                <button type="button" class="btn btn-success btn-save" data-bot-id="${bot.bot_id}"
                                        style="padding: 6px 12px; font-size: 12px; white-space: nowrap;">
                                    <i class="fas fa-save"></i> Save
                                </button>
                            </div>
                        </td>
                        <td>
                            <span style="padding: 4px 12px; background: ${statusInfo.bg}; color: ${statusInfo.text}; border-radius: 6px; font-size: 12px; font-weight: 600; text-transform: uppercase;">
                                ${bot.status || 'offline'}
                            </span>
                        </td>
                        <td>${games}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>${bot.current_load || 0}/${bot.capacity || 1}</span>
                                <div style="width: 60px; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                                    <div style="width: ${loadPercent}%; height: 100%; background: ${loadPercent > 80 ? '#ef4444' : loadPercent > 50 ? '#f59e0b' : '#10b981'}; transition: width 0.3s;"></div>
                                </div>
                                <span style="font-size: 12px; color: #666;">${loadPercent}%</span>
                            </div>
                        </td>
                        <td style="font-size: 13px; color: #666;">${lastHeartbeat}</td>
                        <td style="font-size: 13px; color: #666;">${created}</td>
                        <td>
                            <button type="button" class="btn btn-danger btn-delete" data-bot-id="${bot.bot_id}" data-bot-name="${escapeHtml(bot.bot_name || 'Unnamed Bot')}" 
                                    style="padding: 6px 12px; font-size: 12px;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Event delegation for bot actions
        const botsBodyEl = document.getElementById('botsBody');
        if (botsBodyEl && !botsBodyEl._handlersAttached) {
            botsBodyEl.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const botId = target.getAttribute('data-bot-id');
                if (!botId) return;
                
                if (target.classList.contains('btn-save')) {
                    const nameInput = document.getElementById(`botName_${botId}`);
                    if (!nameInput) {
                        alert('Error: Could not find the name field.');
                        return;
                    }
                    const newName = nameInput.value.trim();
                    if (!newName) {
                        alert('Bot name cannot be empty');
                        return;
                    }
                    if (!authToken) {
                        alert('Error: Not authenticated. Please log in again.');
                        return;
                    }
                    target.disabled = true;
                    const originalText = target.innerHTML;
                    target.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving';
                    try {
                        const response = await makeAuthRequest(`${API_BASE}/admin/bots/${botId}/rename`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: newName })
                        });
                        const data = await response.json().catch(() => ({}));
                        if (!response.ok || !data.success) {
                            throw new Error(data.error || 'Failed to rename bot');
                        }
                        target.innerHTML = '<i class="fas fa-check"></i> Saved';
                        setTimeout(() => { target.innerHTML = originalText; target.disabled = false; }, 800);
                    } catch (err) {
                        target.disabled = false;
                        target.innerHTML = originalText;
                        alert(`Error renaming bot: ${err.message}`);
                    }
                } else if (target.classList.contains('btn-delete')) {
                    const botName = target.getAttribute('data-bot-name') || 'Unnamed Bot';
                    if (!confirm(`Delete bot "${botName}"? This cannot be undone.`)) return;
                    target.disabled = true;
                    const originalText = target.innerHTML;
                    target.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting';
                    try {
                        const response = await makeAuthRequest(`${API_BASE}/admin/bots/${botId}`, { method: 'DELETE' });
                        const data = await response.json().catch(() => ({}));
                        if (!response.ok || !data.success) {
                            throw new Error(data.error || 'Failed to delete bot');
                        }
                        loadBots();
                    } catch (err) {
                        alert(`Error deleting bot: ${err.message}`);
                        target.disabled = false;
                        target.innerHTML = originalText;
                    }
                }
            });
            botsBodyEl._handlersAttached = true;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // No globals needed; actions are handled via event delegation

        // Load users function
        async function loadUsers() {
            console.log('[ADMIN] loadUsers called');
            try {
                const loadingEl = document.getElementById('usersLoading');
                const tableEl = document.getElementById('usersTable');
                const paginationEl = document.getElementById('userPagination');
                
                if (!loadingEl || !tableEl) {
                    console.error('[ADMIN] User elements not found');
                    return;
                }
                
                loadingEl.style.display = 'block';
                tableEl.style.display = 'none';
                if (paginationEl) paginationEl.style.display = 'none';
                
                // Use embedded data if available AND has content
                if (window.__ADMIN_EMBEDDED_DATA__ && 
                    Array.isArray(window.__ADMIN_EMBEDDED_DATA__.users) && 
                    window.__ADMIN_EMBEDDED_DATA__.users.length > 0) {
                    console.log('[ADMIN] Using embedded users:', window.__ADMIN_EMBEDDED_DATA__.users.length);
                    allUsers = window.__ADMIN_EMBEDDED_DATA__.users || [];
                    applyUserFilters();
                    return; // Data loaded from embedded source
                }
                
                console.log('[ADMIN] No embedded users or empty, fetching from API...');
                // Fallback to API
                const response = await makeAuthRequest(`${API_BASE}/users`);
                console.log('[ADMIN] Users API response:', response.status, response.ok);
                if (response.ok) {
                    const data = await response.json();
                    console.log('[ADMIN] Users data:', data);
                    allUsers = data.users || [];
                    applyUserFilters();
                } else {
                    const errorText = await response.text().catch(() => 'Unknown error');
                    console.error('[ADMIN] Users API failed:', response.status, errorText);
                    loadingEl.textContent = 'Error loading users: ' + errorText;
                }
            } catch (error) {
                console.error('[ADMIN] Error loading users:', error);
                const loadingEl = document.getElementById('usersLoading');
                if (loadingEl) {
                    loadingEl.textContent = 'Error loading users: ' + error.message;
                }
            }
        }

        // Filter users based on search query
        function filterUsers(users) {
            if (!userSearchQuery.trim()) {
                return users;
            }
            
            const query = userSearchQuery.toLowerCase().trim();
            return users.filter(user => {
                const name = (user.name || '').toLowerCase();
                const email = (user.email || '').toLowerCase();
                const role = (user.role || 'user').toLowerCase();
                const status = (user.status || 'active').toLowerCase();
                const tier = ((user.tier || 'regular')).toLowerCase();
                
                return name.includes(query) || 
                       email.includes(query) || 
                       role.includes(query) || 
                       status.includes(query) ||
                       tier.includes(query);
            });
        }

        // Apply filters and pagination
        function applyUserFilters() {
            // Filter users
            filteredUsers = filterUsers(allUsers);
            
            // Update user count info
            const totalUsers = allUsers.length;
            const filteredCount = filteredUsers.length;
            const countInfo = document.getElementById('userCountInfo');
            if (countInfo) {
                if (userSearchQuery.trim()) {
                    countInfo.textContent = `Showing ${filteredCount} of ${totalUsers} users (filtered)`;
                } else {
                    countInfo.textContent = `Total: ${totalUsers} users`;
                }
            }
            
            // Calculate pagination
            const totalPages = usersPerPage > 0 ? Math.ceil(filteredUsers.length / usersPerPage) : 1;
            if (currentUserPage > totalPages && totalPages > 0) {
                currentUserPage = totalPages;
            }
            
            // Get users for current page
            let usersToDisplay = filteredUsers;
            if (usersPerPage > 0) {
                const startIndex = (currentUserPage - 1) * usersPerPage;
                const endIndex = startIndex + usersPerPage;
                usersToDisplay = filteredUsers.slice(startIndex, endIndex);
            }
            
            // Display users
            displayUsers(usersToDisplay);
            
            // Update pagination controls
            updateUserPagination(totalPages);
            
            // Hide loading, show table
            document.getElementById('usersLoading').style.display = 'none';
            document.getElementById('usersTable').style.display = 'table';
        }

            function displayUsers(users) {
            const tbody = document.getElementById('usersBody');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Never';
                const roleBadge = user.role === 'admin' ? '<span style="background: #e74c3c; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">Admin</span>' :
                               user.role === 'moderator' ? '<span style="background: #f39c12; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">Mod</span>' :
                               '<span style="background: #95a5a6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">User</span>';
                const userStatus = user.status || 'active'; // Default to 'active' if missing
                const statusBadge = userStatus === 'active' ? '<span style="background: #27ae60; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">Active</span>' :
                                  userStatus === 'suspended' ? '<span style="background: #f39c12; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">Suspended</span>' :
                                  '<span style="background: #e74c3c; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">Banned</span>';
                const userTier = (user.tier || 'regular').toLowerCase();
                const tierColors = {
                    regular: '#95a5a6',
                    basic: '#3498db',
                    standard: '#9b59b6',
                    premium: '#f39c12'
                };
                const tierBadge = `<span style="background: ${tierColors[userTier] || '#95a5a6'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; text-transform: capitalize;">${userTier}</span>`;
                
                return `
                    <tr style="cursor: pointer;" onclick="openUserManagement('${user.googleId}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                        <td>${user.name || 'N/A'}</td>
                        <td>${user.email}</td>
                        <td>${roleBadge}</td>
                        <td>${statusBadge}</td>
                        <td>${tierBadge}</td>
                        <td>${user.stats?.loginCount || 0}</td>
                        <td>${lastLogin}</td>
                        <td onclick="event.stopPropagation();">
                            <button data-google-id="${user.googleId}" class="btn manage-user-btn" style="background: #667eea; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; margin-right: 5px;">Manage</button>
                            <button data-google-id="${user.googleId}" onclick="event.stopPropagation(); openTierEditModal('${user.googleId}', '${userTier}')" class="btn" style="background: #27ae60; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">Edit Tier</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update pagination controls
        function updateUserPagination(totalPages) {
            const pagination = document.getElementById('userPagination');
            const prevBtn = document.getElementById('userPaginationPrev');
            const nextBtn = document.getElementById('userPaginationNext');
            const pagesContainer = document.getElementById('userPaginationPages');
            
            if (totalPages <= 1 || usersPerPage === 0) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            
            // Update prev/next buttons
            prevBtn.disabled = currentUserPage === 1;
            nextBtn.disabled = currentUserPage === totalPages;
            
            // Generate page numbers
            pagesContainer.innerHTML = '';
            const maxVisiblePages = 7;
            let startPage = Math.max(1, currentUserPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // First page
            if (startPage > 1) {
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.style.cssText = 'background: #667eea; color: white; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; min-width: 40px;';
                btn.textContent = '1';
                btn.onclick = () => { currentUserPage = 1; applyUserFilters(); };
                pagesContainer.appendChild(btn);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.cssText = 'padding: 0 5px; color: #666;';
                    pagesContainer.appendChild(ellipsis);
                }
            }
            
            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = 'btn';
                if (i === currentUserPage) {
                    btn.style.cssText = 'background: #667eea; color: white; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; min-width: 40px; font-weight: bold;';
                } else {
                    btn.style.cssText = 'background: #95a5a6; color: white; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; min-width: 40px;';
                }
                btn.textContent = i;
                btn.onclick = () => { currentUserPage = i; applyUserFilters(); };
                pagesContainer.appendChild(btn);
            }
            
            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.cssText = 'padding: 0 5px; color: #666;';
                    pagesContainer.appendChild(ellipsis);
                }
                
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.style.cssText = 'background: #667eea; color: white; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; min-width: 40px;';
                btn.textContent = totalPages;
                btn.onclick = () => { currentUserPage = totalPages; applyUserFilters(); };
                pagesContainer.appendChild(btn);
            }
        }

        // Event listeners for user management
        document.addEventListener('DOMContentLoaded', () => {
            // Search input
            const searchInput = document.getElementById('userSearchInput');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        userSearchQuery = e.target.value;
                        currentUserPage = 1; // Reset to first page on search
                        applyUserFilters();
                    }, 300); // Debounce search
                });
            }
            
            // Users per page selector
            const usersPerPageSelect = document.getElementById('usersPerPage');
            if (usersPerPageSelect) {
                usersPerPageSelect.addEventListener('change', (e) => {
                    usersPerPage = parseInt(e.target.value) || 0;
                    currentUserPage = 1; // Reset to first page
                    applyUserFilters();
                });
            }
            
            // Pagination buttons
            const prevBtn = document.getElementById('userPaginationPrev');
            const nextBtn = document.getElementById('userPaginationNext');
            
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (currentUserPage > 1) {
                        currentUserPage--;
                        applyUserFilters();
                    }
                });
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    const totalPages = usersPerPage > 0 ? Math.ceil(filteredUsers.length / usersPerPage) : 1;
                    if (currentUserPage < totalPages) {
                        currentUserPage++;
                        applyUserFilters();
                    }
                });
            }
        });

        async function updateUserRole(googleId, role) {
            try {
                const response = await makeAuthRequest(`${API_BASE}/users/${googleId}/role`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role })
                });
                if (response.ok) {
                    const data = await response.json();
                    alert(`User role updated to ${role}`);
                    loadUsers();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error || 'Failed to update role'}`);
                }
            } catch (error) {
                console.error('Error updating user role:', error);
                alert('Error updating user role');
            }
        }

        async function updateUserStatus(googleId, status) {
            try {
                const response = await makeAuthRequest(`${API_BASE}/users/${googleId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                if (response.ok) {
                    const data = await response.json();
                    alert(`User status updated to ${status}`);
                    loadUsers();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error || 'Failed to update status'}`);
                }
            } catch (error) {
                console.error('Error updating user status:', error);
                alert('Error updating user status');
            }
        }

        // Make functions globally accessible
        window.updateUserRole = updateUserRole;
        window.updateUserStatus = updateUserStatus;
        window.openUserManagement = openUserManagement;
        window.closeUserManagement = closeUserManagement;
        window.saveUserManagement = saveUserManagement;
        window.deleteUser = deleteUser;

        // Current user being managed
        let currentManagedUser = null;

        // Open user management modal
        async function openUserManagement(googleId) {
            console.log('[USER MANAGEMENT] openUserManagement called with googleId:', googleId);
            const modal = document.getElementById('userManagementModal');
            const content = document.getElementById('userManagementContent');
            
            if (!modal) {
                console.error('[USER MANAGEMENT] Modal element not found');
                return;
            }
            if (!content) {
                console.error('[USER MANAGEMENT] Content element not found');
                return;
            }
            
            console.log('[USER MANAGEMENT] Opening modal...');
            modal.style.display = 'block';
            // Ensure content is visible
            if (content) {
                content.style.display = 'block';
                content.innerHTML = '<div class="loading" style="padding: 2rem; text-align: center;">Loading user data...</div>';
                console.log('[USER MANAGEMENT] Loading message set');
            } else {
                console.error('[USER MANAGEMENT] Content element is null!');
            }
            
            try {
                console.log('[USER MANAGEMENT] Fetching user data from:', `${API_BASE}/users/${googleId}`);
                console.log('[USER MANAGEMENT] API_BASE:', API_BASE);
                console.log('[USER MANAGEMENT] authToken exists:', !!authToken);
                
                // Fetch full user data
                const response = await makeAuthRequest(`${API_BASE}/users/${googleId}`);
                console.log('[USER MANAGEMENT] Response status:', response.status);
                console.log('[USER MANAGEMENT] Response headers:', response.headers);
                
                if (!response.ok) {
                    let errorText = '';
                    try {
                        errorText = await response.text();
                    } catch (e) {
                        errorText = 'Could not read error response';
                    }
                    console.error('[USER MANAGEMENT] Response error:', errorText);
                    throw new Error(`Failed to load user data: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('[USER MANAGEMENT] User data received:', data);
                console.log('[USER MANAGEMENT] Data keys:', Object.keys(data));
                console.log('[USER MANAGEMENT] data.success:', data.success);
                console.log('[USER MANAGEMENT] data.user exists:', !!data.user);
                
                if (!data.success) {
                    throw new Error(data.error || 'Request was not successful');
                }
                
                if (!data.user) {
                    throw new Error('User data not found in response');
                }
                
                currentManagedUser = data.user;
                console.log('[USER MANAGEMENT] Calling renderUserManagementForm with user:', {
                    googleId: data.user.googleId,
                    email: data.user.email,
                    name: data.user.name
                });
                renderUserManagementForm(data.user);
                console.log('[USER MANAGEMENT] renderUserManagementForm completed');
            } catch (error) {
                console.error('[USER MANAGEMENT] Error loading user:', error);
                console.error('[USER MANAGEMENT] Error name:', error.name);
                console.error('[USER MANAGEMENT] Error message:', error.message);
                console.error('[USER MANAGEMENT] Error stack:', error.stack);
                if (content) {
                    content.innerHTML = `<div class="error" style="padding: 20px; color: #e74c3c; background: #fee; border-radius: 8px; display: block;">
                        <h4 style="margin-top: 0;">Error loading user</h4>
                        <p>${error.message || 'Unknown error'}</p>
                        <p style="font-size: 0.85em; color: #999;">Check the browser console for more details.</p>
                    </div>`;
                    content.style.display = 'block';
                }
            }
        }

        // Close user management modal
        function closeUserManagement() {
            const modal = document.getElementById('userManagementModal');
            if (modal) {
                modal.style.display = 'none';
            }
            currentManagedUser = null;
        }

        // Render user management form
        function renderUserManagementForm(user) {
            console.log('[USER MANAGEMENT] renderUserManagementForm called with user:', user);
            const content = document.getElementById('userManagementContent');
            if (!content) {
                console.error('[USER MANAGEMENT] Content element not found in renderUserManagementForm');
                return;
            }
            console.log('[USER MANAGEMENT] Rendering form content...');
            
            const memberSince = user.createdAt ? new Date(user.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Unknown';
            const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Never';
            const displayName = (user.profile?.displayName || user.name || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            const bio = (user.profile?.bio || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            const location = (user.profile?.location || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            const website = (user.profile?.website || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            const adminNotes = (user.adminNotes || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            const banReason = (user.banReason || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            const suspensionEndDate = user.suspensionEndDate || '';
            const userName = (user.name || 'N/A').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            const userEmail = (user.email || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            const userPicture = (user.picture || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            const userGoogleId = (user.googleId || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            
            try {
                content.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                    <!-- Left Column -->
                    <div>
                        <!-- User Info Section -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #333; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">User Information</h3>
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                                <img src="${userPicture}" alt="Profile" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #667eea;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'80\\' height=\\'80\\'%3E%3Ccircle cx=\\'40\\' cy=\\'40\\' r=\\'40\\' fill=\\'%23667eea\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\' fill=\\'white\\' font-size=\\'32\\'%3E${userName.charAt(0).toUpperCase()}%3C/text%3E%3C/svg%3E'">
                                <div>
                                    <div style="font-size: 1.2em; font-weight: 600; color: #333;">${userName}</div>
                                    <div style="color: #666; font-size: 0.9em;">${userEmail}</div>
                                    <div style="color: #999; font-size: 0.8em; margin-top: 5px;">ID: ${userGoogleId}</div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #666; font-weight: 600; font-size: 0.9em;">Member Since</label>
                                    <div style="color: #333;">${memberSince}</div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #666; font-weight: 600; font-size: 0.9em;">Last Login</label>
                                    <div style="color: #333;">${lastLogin}</div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #666; font-weight: 600; font-size: 0.9em;">Total Logins</label>
                                    <div style="color: #333; font-weight: 600;">${user.stats?.loginCount || 0}</div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #666; font-weight: 600; font-size: 0.9em;">Account Created</label>
                                    <div style="color: #333;">${new Date(user.createdAt || Date.now()).toLocaleDateString()}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Role & Status Section -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #333; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">Role & Status</h3>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="manageUserRole" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">Role</label>
                                <select id="manageUserRole" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                                    <option value="moderator" ${user.role === 'moderator' ? 'selected' : ''}>Moderator</option>
                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="manageUserStatus" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">Status</label>
                                <select id="manageUserStatus" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    <option value="active" ${(user.status || 'active') === 'active' ? 'selected' : ''}>Active</option>
                                    <option value="suspended" ${user.status === 'suspended' ? 'selected' : ''}>Suspended</option>
                                    <option value="banned" ${user.status === 'banned' ? 'selected' : ''}>Banned</option>
                                </select>
                            </div>
                            
                            <div class="form-group" id="suspensionDateGroup" style="margin-bottom: 15px; display: ${user.status === 'suspended' ? 'block' : 'none'};">
                                <label for="suspensionEndDate" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">Suspension End Date</label>
                                <input type="datetime-local" id="suspensionEndDate" value="${suspensionEndDate ? new Date(suspensionEndDate).toISOString().slice(0, 16) : ''}" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            </div>
                            
                            <div class="form-group" id="banReasonGroup" style="margin-bottom: 15px; display: ${user.status === 'banned' ? 'block' : 'none'};">
                                <label for="banReason" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">Ban Reason</label>
                                <textarea id="banReason" rows="3" placeholder="Enter reason for ban..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;">${banReason}</textarea>
                            </div>
                        </div>

                        <!-- Admin Notes Section -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #333; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">Admin Notes</h3>
                            <textarea id="adminNotes" rows="4" placeholder="Add internal notes about this user..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;">${adminNotes}</textarea>
                            <div style="color: #666; font-size: 0.85em; margin-top: 5px;">These notes are only visible to admins</div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div>
                        <!-- Profile Section -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #333; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">Profile Information</h3>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="manageDisplayName" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">Display Name</label>
                                <input type="text" id="manageDisplayName" value="${displayName}" placeholder="Display name" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="manageBio" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">Bio</label>
                                <textarea id="manageBio" rows="3" placeholder="User bio" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;">${bio}</textarea>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="manageLocation" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">Location</label>
                                <input type="text" id="manageLocation" value="${location}" placeholder="Location" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="manageWebsite" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">Website</label>
                                <input type="url" id="manageWebsite" value="${website}" placeholder="https://example.com" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>

                        <!-- Preferences Section -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #333; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">Preferences</h3>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="manageTheme" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">Theme</label>
                                <select id="manageTheme" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    <option value="light" ${user.preferences?.theme === 'light' ? 'selected' : ''}>Light</option>
                                    <option value="dark" ${user.preferences?.theme === 'dark' ? 'selected' : ''}>Dark</option>
                                    <option value="auto" ${user.preferences?.theme === 'auto' ? 'selected' : ''}>Auto</option>
                                </select>
                            </div>
                            
                            <div style="display: flex; gap: 20px; margin-top: 15px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="manageNotifications" ${user.preferences?.notifications !== false ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="color: #333; font-weight: 500;">Notifications</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="manageEmailNotifications" ${user.preferences?.emailNotifications !== false ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="color: #333; font-weight: 500;">Email Notifications</span>
                                </label>
                            </div>
                        </div>

                        <!-- Activity Log Section -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #333; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">Recent Activity</h3>
                            <div id="userActivityLog" style="max-height: 300px; overflow-y: auto;">
                                <div class="loading">Loading activity...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-top: 2px solid #e0e0e0; background: #f8f9fa; border-radius: 0 0 16px 16px;">
                    <div style="display: flex; gap: 10px;">
                        <button data-action="delete" data-google-id="${user.googleId}" class="user-mgmt-btn user-mgmt-delete" style="background: #e74c3c; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;" title="Delete this user permanently">üóëÔ∏è Delete User</button>
                        ${(user.status || 'active') === 'suspended' ? `<button data-action="unsuspend" data-google-id="${user.googleId}" class="user-mgmt-btn user-mgmt-unsuspend" style="background: #27ae60; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;" title="Unsuspend this user">‚úÖ Unsuspend</button>` : ''}
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button data-action="cancel" class="user-mgmt-btn user-mgmt-cancel" style="background: #95a5a6; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
                        <button data-action="save" data-google-id="${user.googleId}" class="user-mgmt-btn user-mgmt-save" style="background: #27ae60; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">üíæ Save Changes</button>
                    </div>
                </div>
            `;
            } catch (templateError) {
                console.error('[USER MANAGEMENT] Error rendering template:', templateError);
                content.innerHTML = `<div class="error" style="padding: 20px; color: #e74c3c; background: #fee; border-radius: 8px;">Error rendering form: ${templateError.message}</div>`;
                return;
            }
            
            console.log('[USER MANAGEMENT] Form HTML set, content length:', content.innerHTML.length);
            console.log('[USER MANAGEMENT] Content element display:', window.getComputedStyle(content).display);
            console.log('[USER MANAGEMENT] Content element visibility:', window.getComputedStyle(content).visibility);
            
            // Ensure content is visible
            content.style.display = 'block';
            content.style.visibility = 'visible';
            
            // Show/hide suspension and ban fields based on status
            const statusSelect = document.getElementById('manageUserStatus');
            if (statusSelect) {
                statusSelect.addEventListener('change', function() {
                    const suspensionGroup = document.getElementById('suspensionDateGroup');
                    const banGroup = document.getElementById('banReasonGroup');
                    if (suspensionGroup) suspensionGroup.style.display = this.value === 'suspended' ? 'block' : 'none';
                    if (banGroup) banGroup.style.display = this.value === 'banned' ? 'block' : 'none';
                });
            }
            
            // Load activity log
            loadUserActivityLog(user.googleId);
        }

        // Load user activity log
        async function loadUserActivityLog(googleId) {
            const container = document.getElementById('userActivityLog');
            if (!container) return;
            
            try {
                const response = await makeAuthRequest(`${API_BASE}/users/${googleId}/activity?limit=20`);
                if (!response.ok) {
                    throw new Error('Failed to load activity log');
                }
                
                const data = await response.json();
                if (!data.success || !data.logs) {
                    container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No activity logs found</div>';
                    return;
                }
                
                if (data.logs.length === 0) {
                    container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No activity logs found</div>';
                    return;
                }
                
                container.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        <thead>
                            <tr style="background: #e0e0e0; border-bottom: 2px solid #ccc;">
                                <th style="padding: 8px; text-align: left;">Event</th>
                                <th style="padding: 8px; text-align: left;">IP</th>
                                <th style="padding: 8px; text-align: left;">Date</th>
                                <th style="padding: 8px; text-align: left;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.logs.map(log => {
                                const date = new Date(log.timestamp);
                                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                                const statusColor = log.status === 'Success' ? '#27ae60' : log.status === 'Error' ? '#e74c3c' : '#3498db';
                                return `
                                    <tr style="border-bottom: 1px solid #e0e0e0;">
                                        <td style="padding: 8px;">${log.event || 'N/A'}</td>
                                        <td style="padding: 8px; font-family: monospace; font-size: 0.85em;">${log.ipAddress || 'N/A'}</td>
                                        <td style="padding: 8px; color: #666;">${formattedDate}</td>
                                        <td style="padding: 8px;"><span style="background: ${statusColor}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">${log.status || 'Info'}</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading activity log:', error);
                container.innerHTML = `<div style="color: #e74c3c; text-align: center; padding: 20px;">Error loading activity log</div>`;
            }
        }

        // Save user management changes
        async function saveUserManagement(googleId) {
            try {
                const role = document.getElementById('manageUserRole').value;
                const status = document.getElementById('manageUserStatus').value;
                const displayName = document.getElementById('manageDisplayName').value.trim();
                const bio = document.getElementById('manageBio').value.trim();
                const location = document.getElementById('manageLocation').value.trim();
                const website = document.getElementById('manageWebsite').value.trim();
                const theme = document.getElementById('manageTheme').value;
                const notifications = document.getElementById('manageNotifications').checked;
                const emailNotifications = document.getElementById('manageEmailNotifications').checked;
                const adminNotes = document.getElementById('adminNotes').value.trim();
                const banReason = document.getElementById('banReason') ? document.getElementById('banReason').value.trim() : '';
                const suspensionEndDate = document.getElementById('suspensionEndDate') ? document.getElementById('suspensionEndDate').value : '';
                
                // Build updates object - only include fields that are provided
                const updates = {
                    role,
                    status,
                };
                
                // Only include profile if there are profile fields
                if (displayName || bio || location || website) {
                    updates.profile = {};
                    if (displayName !== undefined) updates.profile.displayName = displayName;
                    if (bio !== undefined) updates.profile.bio = bio;
                    if (location !== undefined) updates.profile.location = location;
                    if (website !== undefined) {
                        // Only include website if it's a valid URL or empty
                        if (website === '' || website.startsWith('http://') || website.startsWith('https://')) {
                            updates.profile.website = website;
                        } else if (website) {
                            // Try to add https:// if no protocol
                            updates.profile.website = 'https://' + website;
                        }
                    }
                }
                
                // Only include preferences if there are preference fields
                if (theme || notifications !== undefined || emailNotifications !== undefined) {
                    updates.preferences = {};
                    if (theme) updates.preferences.theme = theme;
                    if (notifications !== undefined) updates.preferences.notifications = notifications;
                    if (emailNotifications !== undefined) updates.preferences.emailNotifications = emailNotifications;
                }
                
                // Admin-specific fields
                if (adminNotes !== undefined) updates.adminNotes = adminNotes;
                if (status === 'banned' && banReason !== undefined) {
                    updates.banReason = banReason;
                } else if (status !== 'banned') {
                    updates.banReason = '';
                }
                if (status === 'suspended' && suspensionEndDate) {
                    updates.suspensionEndDate = suspensionEndDate;
                } else if (status !== 'suspended') {
                    updates.suspensionEndDate = '';
                }
                
                console.log('[USER MANAGEMENT] Sending update request:', updates);
                
                const response = await makeAuthRequest(`${API_BASE}/users/${googleId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates),
                });
                
                console.log('[USER MANAGEMENT] Update response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('[USER MANAGEMENT] Update error:', errorData);
                    let errorMessage = errorData.error || 'Failed to update user';
                    if (errorData.details && Array.isArray(errorData.details)) {
                        errorMessage += '\n\nValidation errors:\n' + errorData.details.map(d => `- ${d.msg || d.message || JSON.stringify(d)}`).join('\n');
                    }
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                console.log('[USER MANAGEMENT] Update successful:', result);
                
                alert('User updated successfully!');
                closeUserManagement();
                loadUsers(); // Refresh user list
            } catch (error) {
                console.error('[USER MANAGEMENT] Error saving user:', error);
                alert(`Error: ${error.message || 'Failed to save changes'}`);
            }
        }

        // Delete user
        async function deleteUser(googleId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone!')) {
                return;
            }
            
            if (!confirm('This will permanently delete the user and all their data. Are you absolutely sure?')) {
                return;
            }
            
            try {
                const response = await makeAuthRequest(`${API_BASE}/users/${googleId}`, {
                    method: 'DELETE',
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete user');
                }
                
                alert('User deleted successfully!');
                closeUserManagement();
                loadUsers(); // Refresh user list
            } catch (error) {
                console.error('Error deleting user:', error);
                alert(`Error: ${error.message || 'Failed to delete user'}`);
            }
        }

        // Unsuspend user
        async function unsuspendUser(googleId) {
            if (!confirm('Are you sure you want to unsuspend this user?')) {
                return;
            }
            
            try {
                const response = await makeAuthRequest(`${API_BASE}/users/${googleId}/unsuspend`, {
                    method: 'POST',
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to unsuspend user');
                }
                
                alert('User unsuspended successfully!');
                closeUserManagement();
                loadUsers(); // Refresh user list
            } catch (error) {
                console.error('Error unsuspending user:', error);
                alert(`Error: ${error.message || 'Failed to unsuspend user'}`);
            }
        }

        // Make unsuspendUser globally accessible
        window.unsuspendUser = unsuspendUser;

        // Close modal on outside click
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('userManagementModal');
            if (modal && e.target === modal) {
                closeUserManagement();
            }
        });

        // Add event listeners for manage buttons (using event delegation)
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('manage-user-btn') || e.target.closest('.manage-user-btn')) {
                const button = e.target.classList.contains('manage-user-btn') ? e.target : e.target.closest('.manage-user-btn');
                const googleId = button.getAttribute('data-google-id');
                console.log('[USER MANAGEMENT] Manage button clicked, googleId:', googleId);
                if (googleId) {
                    e.stopPropagation();
                    e.preventDefault();
                    if (typeof openUserManagement === 'function') {
                        openUserManagement(googleId);
                    } else {
                        console.error('[USER MANAGEMENT] openUserManagement is not a function');
                    }
                }
            }
            
            // Handle user management modal buttons
            if (e.target.classList.contains('user-mgmt-btn') || e.target.closest('.user-mgmt-btn')) {
                const button = e.target.classList.contains('user-mgmt-btn') ? e.target : e.target.closest('.user-mgmt-btn');
                const action = button.getAttribute('data-action');
                const googleId = button.getAttribute('data-google-id');
                
                console.log('[USER MANAGEMENT] Modal button clicked, action:', action, 'googleId:', googleId);
                
                e.stopPropagation();
                e.preventDefault();
                
                switch (action) {
                    case 'close':
                    case 'cancel':
                        if (typeof closeUserManagement === 'function') {
                            closeUserManagement();
                        } else {
                            console.error('[USER MANAGEMENT] closeUserManagement is not a function');
                        }
                        break;
                    case 'save':
                        if (googleId && typeof saveUserManagement === 'function') {
                            saveUserManagement(googleId);
                        } else {
                            console.error('[USER MANAGEMENT] saveUserManagement is not a function or googleId missing');
                        }
                        break;
                    case 'delete':
                        if (googleId && typeof deleteUser === 'function') {
                            deleteUser(googleId);
                        } else {
                            console.error('[USER MANAGEMENT] deleteUser is not a function or googleId missing');
                        }
                        break;
                    case 'unsuspend':
                        if (googleId && typeof unsuspendUser === 'function') {
                            unsuspendUser(googleId);
                        } else {
                            console.error('[USER MANAGEMENT] unsuspendUser is not a function or googleId missing');
                        }
                        break;
                    default:
                        console.warn('[USER MANAGEMENT] Unknown action:', action);
                }
            }
        });

        // Load IP Whitelist
        async function loadIPWhitelist() {
            const loading = document.getElementById('whitelistLoading');
            const table = document.getElementById('whitelistTable');
            const empty = document.getElementById('whitelistEmpty');
            const tbody = document.getElementById('whitelistBody');
            
            if (!loading || !table || !empty || !tbody) return;
            
            try {
                loading.style.display = 'block';
                table.style.display = 'none';
                empty.style.display = 'none';
                
                const response = await makeAuthRequest(`${API_BASE}/ip-whitelist`);
                if (!response.ok) {
                    throw new Error('Failed to load IP whitelist');
                }
                
                const data = await response.json();
                if (data.success && data.ips) {
                    if (data.ips.length === 0) {
                        loading.style.display = 'none';
                        empty.style.display = 'block';
                    } else {
                        tbody.innerHTML = data.ips.map(ip => `
                            <tr>
                                <td style="font-family: monospace; font-size: 0.95em;">${ip}</td>
                                <td>
                                    <button onclick="removeFromWhitelist('${ip}')" class="btn btn-danger" style="padding: 6px 12px; font-size: 0.9em;">Remove</button>
                                </td>
                            </tr>
                        `).join('');
                        loading.style.display = 'none';
                        table.style.display = 'table';
                    }
                }
            } catch (error) {
                console.error('Error loading IP whitelist:', error);
                loading.textContent = 'Error loading IP whitelist';
            }
        }

        // Add IP to whitelist
        async function addToWhitelist() {
            const input = document.getElementById('newIPAddress');
            const ipAddress = input?.value.trim();
            
            if (!ipAddress) {
                alert('Please enter an IP address');
                return;
            }
            
            try {
                const response = await makeAuthRequest(`${API_BASE}/ip-whitelist`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ipAddress }),
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add IP to whitelist');
                }
                
                input.value = '';
                alert('IP added to whitelist successfully!');
                loadIPWhitelist();
            } catch (error) {
                console.error('Error adding IP to whitelist:', error);
                alert(`Error: ${error.message || 'Failed to add IP to whitelist'}`);
            }
        }

        // Remove IP from whitelist
        async function removeFromWhitelist(ipAddress) {
            if (!confirm(`Are you sure you want to remove ${ipAddress} from the whitelist?`)) {
                return;
            }
            
            try {
                const encodedIP = encodeURIComponent(ipAddress);
                const response = await makeAuthRequest(`${API_BASE}/ip-whitelist/${encodedIP}`, {
                    method: 'DELETE',
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to remove IP from whitelist');
                }
                
                alert('IP removed from whitelist successfully!');
                loadIPWhitelist();
            } catch (error) {
                console.error('Error removing IP from whitelist:', error);
                alert(`Error: ${error.message || 'Failed to remove IP from whitelist'}`);
            }
        }

        // Make functions globally accessible
        window.addToWhitelist = addToWhitelist;
        window.removeFromWhitelist = removeFromWhitelist;

        // Add event listeners for IP whitelist
        document.addEventListener('DOMContentLoaded', () => {
            const addIPBtn = document.getElementById('addIPBtn');
            const newIPInput = document.getElementById('newIPAddress');
            
            if (addIPBtn) {
                addIPBtn.addEventListener('click', addToWhitelist);
            }
            
            if (newIPInput) {
                newIPInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addToWhitelist();
                    }
                });
            }
        });

        // Load Ko-fi data
        async function loadKofiData() {
            console.log('[ADMIN] loadKofiData called');
            try {
                // Load tier members and stats
                console.log('[ADMIN] Fetching Ko-fi tiers from:', `${API_BASE}/admin/kofi/tiers`);
                const tiersResponse = await makeAuthRequest(`${API_BASE}/admin/kofi/tiers`);
                console.log('[ADMIN] Ko-fi tiers response:', tiersResponse.status, tiersResponse.ok);
                
                if (!tiersResponse.ok) {
                    const errorText = await tiersResponse.text().catch(() => 'Unknown error');
                    console.error('[ADMIN] Ko-fi tiers API error:', tiersResponse.status, errorText);
                    throw new Error(`Failed to load tier data: ${tiersResponse.status}`);
                }
                
                const tiersData = await tiersResponse.json();
                console.log('[ADMIN] Ko-fi tiers data:', tiersData);

                // Display tier statistics
                const statsDiv = document.getElementById('kofiStats');
                if (tiersData.stats && tiersData.stats.length > 0) {
                    statsDiv.innerHTML = `
                        <table class="data-table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Tier Name</th>
                                    <th>Active Members</th>
                                    <th>Total Revenue</th>
                                    <th>Avg Payments</th>
                                    <th>First Subscription</th>
                                    <th>Last Payment</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tiersData.stats.map(stat => `
                                    <tr>
                                        <td><strong>${escapeHtml(stat.tier_name || 'N/A')}</strong></td>
                                        <td>${stat.member_count || 0}</td>
                                        <td>$${parseFloat(stat.total_revenue || 0).toFixed(2)}</td>
                                        <td>${parseFloat(stat.avg_payments || 0).toFixed(1)}</td>
                                        <td>${stat.first_subscription ? new Date(stat.first_subscription).toLocaleDateString() : 'N/A'}</td>
                                        <td>${stat.last_payment ? new Date(stat.last_payment).toLocaleDateString() : 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    statsDiv.innerHTML = '<p style="text-align: center; color: #666;">No tier statistics available</p>';
                }

                // Display tier members
                const tiersDiv = document.getElementById('kofiTiers');
                if (tiersData.tiers && Object.keys(tiersData.tiers).length > 0) {
                    let tiersHTML = '';
                    for (const [tierName, members] of Object.entries(tiersData.tiers)) {
                        tiersHTML += `
                            <div style="margin-bottom: 30px;">
                                <h4 style="margin-bottom: 10px; color: #667eea;">${escapeHtml(tierName)} (${members.length} member${members.length !== 1 ? 's' : ''})</h4>
                                <table class="data-table" style="width: 100%;">
                                    <thead>
                                        <tr>
                                            <th>Email</th>
                                            <th>Status</th>
                                            <th>Total Payments</th>
                                            <th>Total Amount</th>
                                            <th>Subscription Start</th>
                                            <th>Last Payment</th>
                                            <th>Next Payment</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${members.map(member => `
                                            <tr>
                                                <td>${escapeHtml(member.email || 'N/A')}</td>
                                                <td><span style="padding: 4px 8px; border-radius: 4px; background: ${member.status === 'active' ? '#10b981' : '#ef4444'}; color: white; font-size: 0.85em;">${escapeHtml(member.status || 'unknown')}</span></td>
                                                <td>${member.total_payments || 0}</td>
                                                <td>$${parseFloat(member.total_amount || 0).toFixed(2)} ${member.currency || 'USD'}</td>
                                                <td>${member.subscription_start_date ? new Date(member.subscription_start_date).toLocaleDateString() : 'N/A'}</td>
                                                <td>${member.last_payment_date ? new Date(member.last_payment_date).toLocaleDateString() : 'N/A'}</td>
                                                <td>${member.next_payment_date ? new Date(member.next_payment_date).toLocaleDateString() : 'N/A'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    tiersDiv.innerHTML = tiersHTML;
                } else {
                    tiersDiv.innerHTML = '<p style="text-align: center; color: #666;">No tier memberships found</p>';
                }

                // Load recent subscriptions
                console.log('[ADMIN] Fetching Ko-fi subscriptions from:', `${API_BASE}/admin/kofi/subscriptions?limit=50`);
                const subsResponse = await makeAuthRequest(`${API_BASE}/admin/kofi/subscriptions?limit=50`);
                console.log('[ADMIN] Ko-fi subscriptions response:', subsResponse.status, subsResponse.ok);
                
                if (!subsResponse.ok) {
                    const errorText = await subsResponse.text().catch(() => 'Unknown error');
                    console.error('[ADMIN] Ko-fi subscriptions API error:', subsResponse.status, errorText);
                    throw new Error(`Failed to load subscriptions: ${subsResponse.status}`);
                }
                
                const subsData = await subsResponse.json();
                console.log('[ADMIN] Ko-fi subscriptions data:', {
                    success: subsData.success,
                    count: subsData.count,
                    total: subsData.total,
                    subscriptionsCount: subsData.subscriptions?.length || 0
                });

                const subsDiv = document.getElementById('kofiSubscriptions');
                if (subsData.subscriptions && subsData.subscriptions.length > 0) {
                    // Categorize subscriptions by type
                    const byType = {
                        'Subscription': subsData.subscriptions.filter(s => s.type === 'Subscription'),
                        'Donation': subsData.subscriptions.filter(s => s.type === 'Donation'),
                        'Shop Order': subsData.subscriptions.filter(s => s.type === 'Shop Order'),
                        'Commission': subsData.subscriptions.filter(s => s.type === 'Commission'),
                        'Other': subsData.subscriptions.filter(s => !['Subscription', 'Donation', 'Shop Order', 'Commission'].includes(s.type))
                    };

                    // Group subscriptions by tier (for Subscription type)
                    const byTier = {};
                    byType['Subscription'].forEach(sub => {
                        const tier = sub.tier_name || 'No Tier';
                        if (!byTier[tier]) byTier[tier] = [];
                        byTier[tier].push(sub);
                    });

                    let html = '<div style="margin-bottom: 2rem;">';
                    
                    // Summary by type
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">';
                    Object.entries(byType).forEach(([type, subs]) => {
                        if (subs.length > 0) {
                            const total = subs.reduce((sum, s) => sum + parseFloat(s.amount || 0), 0);
                            html += `
                                <div style="background: rgba(14, 17, 23, 0.6); padding: 1rem; border-radius: 12px; border: 1px solid rgba(140, 82, 255, 0.25);">
                                    <div style="font-size: 0.875rem; color: #999; margin-bottom: 0.5rem;">${type}</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--text);">${subs.length}</div>
                                    <div style="font-size: 0.875rem; color: #666; margin-top: 0.25rem;">$${total.toFixed(2)}</div>
                                </div>
                            `;
                        }
                    });
                    html += '</div>';

                    // Main table with all subscriptions
                    html += `
                        <table class="data-table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>From</th>
                                    <th>Email</th>
                                    <th>Tier</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Claimed</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${subsData.subscriptions.map(sub => {
                                    const typeColors = {
                                        'Subscription': '#9b59b6',
                                        'Donation': '#3498db',
                                        'Shop Order': '#e67e22',
                                        'Commission': '#1abc9c',
                                        'Other': '#667eea'
                                    };
                                    const typeColor = typeColors[sub.type] || '#667eea';
                                    const isClaimed = sub.is_claimed === 1 || sub.is_claimed === true || sub.claimed_id;
                                    const claimedStatus = isClaimed 
                                        ? `<span style="padding: 4px 8px; border-radius: 4px; background: #10b981; color: white; font-size: 0.85em;" title="Claimed on ${sub.claimed_at ? new Date(sub.claimed_at).toLocaleString() : 'N/A'}">‚úì Claimed</span>`
                                        : `<span style="padding: 4px 8px; border-radius: 4px; background: #6b7280; color: white; font-size: 0.85em;">Unclaimed</span>`;
                                    return `
                                        <tr>
                                            <td>${sub.created_at ? new Date(sub.created_at).toLocaleString() : 'N/A'}</td>
                                            <td><span style="padding: 4px 8px; border-radius: 4px; background: ${typeColor}; color: white; font-size: 0.85em;">${escapeHtml(sub.type || 'N/A')}</span></td>
                                            <td>${escapeHtml(sub.from_name || 'N/A')}</td>
                                            <td>${escapeHtml(sub.email || 'N/A')}</td>
                                            <td>${escapeHtml(sub.tier_name || '-')}</td>
                                            <td>$${parseFloat(sub.amount || 0).toFixed(2)} ${sub.currency || 'USD'}</td>
                                            <td><span style="padding: 4px 8px; border-radius: 4px; background: ${sub.status === 'active' ? '#10b981' : sub.status === 'cancelled' ? '#ef4444' : '#6b7280'}; color: white; font-size: 0.85em;">${escapeHtml(sub.status || 'unknown')}</span></td>
                                            <td>${claimedStatus}</td>
                                            <td>
                                                <button data-subscription-id="${sub.id}" class="btn btn-danger delete-kofi-subscription" style="padding: 4px 8px; font-size: 0.85em;" title="Delete this record">Delete</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        <p style="margin-top: 15px; color: #666; text-align: center;">Showing ${subsData.count} of ${subsData.total} total subscriptions</p>
                    `;
                    html += '</div>';
                    subsDiv.innerHTML = html;
                    
                    // Attach event listeners to delete buttons using event delegation
                    const deleteButtons = subsDiv.querySelectorAll('.delete-kofi-subscription');
                    deleteButtons.forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            const subscriptionId = this.getAttribute('data-subscription-id');
                            if (subscriptionId) {
                                deleteKofiSubscription(parseInt(subscriptionId, 10));
                            }
                        });
                    });
                } else {
                    subsDiv.innerHTML = '<p style="text-align: center; color: #666;">No subscriptions found</p>';
                }
            } catch (error) {
                console.error('[ADMIN] Error loading Ko-fi data:', error);
                console.error('[ADMIN] Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                const errorMsg = escapeHtml(error.message || 'Unknown error');
                const statsDiv = document.getElementById('kofiStats');
                const tiersDiv = document.getElementById('kofiTiers');
                const subsDiv = document.getElementById('kofiSubscriptions');
                
                if (statsDiv) {
                    statsDiv.innerHTML = `<p style="text-align: center; color: #ef4444;">Error loading tier statistics: ${errorMsg}</p>`;
                }
                if (tiersDiv) {
                    tiersDiv.innerHTML = `<p style="text-align: center; color: #ef4444;">Error loading tier memberships: ${errorMsg}</p>`;
                }
                if (subsDiv) {
                    subsDiv.innerHTML = `<p style="text-align: center; color: #ef4444;">Error loading subscriptions: ${errorMsg}</p>`;
                }
            }
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            if (text == null) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Delete Ko-fi subscription
        async function deleteKofiSubscription(id) {
            if (!id || isNaN(parseInt(id, 10))) {
                console.error('[ADMIN] Invalid subscription ID:', id);
                alert('Invalid subscription ID');
                return;
            }

            if (!confirm(`Are you sure you want to delete subscription record #${id}? This will also delete any claimed subscriptions associated with it. This action cannot be undone.`)) {
                return;
            }

            try {
                console.log('[ADMIN] Deleting Ko-fi subscription:', id);
                const response = await makeAuthRequest(`${API_BASE}/admin/kofi/subscriptions/${id}`, {
                    method: 'DELETE'
                });

                console.log('[ADMIN] Delete response status:', response.status, response.ok);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('[ADMIN] Delete error response:', errorData);
                    throw new Error(errorData.error || `Failed to delete subscription (${response.status})`);
                }

                const result = await response.json();
                console.log('[ADMIN] Delete success:', result);
                alert('Subscription deleted successfully!');
                loadKofiData(); // Reload the data
            } catch (error) {
                console.error('[ADMIN] Error deleting Ko-fi subscription:', error);
                console.error('[ADMIN] Error stack:', error.stack);
                alert(`Error: ${error.message || 'Failed to delete subscription'}`);
            }
        }

        // Make function globally accessible
        window.deleteKofiSubscription = deleteKofiSubscription;

        // Update showSection to load data when section is shown
        const originalShowSection = showSection;
        showSection = function(section) {
            originalShowSection(section);
            if (section === 'ip-whitelist') {
                loadIPWhitelist();
            } else if (section === 'kofi') {
                loadKofiData();
            }
        };

        // Auto-refresh dashboard every 30 seconds
        setInterval(() => {
            if (authToken && currentSection === 'dashboard') {
                loadDashboardData();
            }
        }, 30000);

        // Tier editing functions
        let currentEditingUserId = null;

        function openTierEditModal(googleId, currentTier) {
            currentEditingUserId = googleId;
            const modal = document.getElementById('tierEditModal');
            const tierSelect = document.getElementById('editTier');
            const durationFields = document.getElementById('durationFields');
            
            tierSelect.value = currentTier || 'regular';
            durationFields.style.display = tierSelect.value === 'regular' ? 'none' : 'block';
            
            // Show modal
            modal.style.display = 'flex';
            
            // Update duration fields visibility when tier changes
            tierSelect.onchange = function() {
                durationFields.style.display = this.value === 'regular' ? 'none' : 'block';
            };
        }

        function closeTierEditModal() {
            const modal = document.getElementById('tierEditModal');
            modal.style.display = 'none';
            currentEditingUserId = null;
        }

        async function saveTierEdit() {
            if (!currentEditingUserId) {
                alert('No user selected');
                return;
            }

            const tier = document.getElementById('editTier').value;
            const duration = document.getElementById('editDuration').value;
            const durationUnit = document.getElementById('editDurationUnit').value;

            if (tier !== 'regular' && (!duration || parseInt(duration) < 1)) {
                alert('Please enter a valid duration (minimum 1)');
                return;
            }

            try {
                const requestBody = { tier };
                if (tier !== 'regular') {
                    requestBody.duration = parseInt(duration);
                    requestBody.durationUnit = durationUnit;
                }

                const response = await makeAuthRequest(`${API_BASE}/users/${currentEditingUserId}/tier`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody),
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert('User tier updated successfully!');
                    closeTierEditModal();
                    loadUsers(); // Refresh user list
                } else {
                    alert('Error: ' + (data.error || 'Failed to update tier'));
                }
            } catch (error) {
                console.error('Error updating tier:', error);
                alert('Error: ' + error.message);
            }
        }

        // Export user data
        async function exportUserData() {
            try {
                const response = await makeAuthRequest(`${API_BASE}/users/export`, {
                    method: 'GET',
                    responseType: 'blob',
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `richieslab_users_export_${new Date().toISOString().split('T')[0]}.sql`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    alert('User data exported successfully!');
                } else {
                    const text = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(text);
                    } catch {
                        errorData = { error: text || 'Unknown error' };
                    }
                    alert('Error: ' + (errorData.error || 'Failed to export data'));
                }
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error: ' + error.message);
            }
        }

        // Import user data
        async function importUserData(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            if (!confirm('Are you sure you want to import user data? This will modify the database. Make sure you have a backup!')) {
                event.target.value = '';
                return;
            }

            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const sqlContent = e.target.result;
                        const response = await makeAuthRequest(`${API_BASE}/users/import`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ sqlContent }),
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            alert('User data imported successfully!');
                            loadUsers(); // Refresh user list
                        } else {
                            alert('Error: ' + (data.error || 'Failed to import data'));
                        }
                    } catch (error) {
                        console.error('Error importing data:', error);
                        alert('Error: ' + error.message);
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // Reset file input
            } catch (error) {
                console.error('Error reading file:', error);
                alert('Error reading file: ' + error.message);
            }
        }
    </script>
</body>
</html>

